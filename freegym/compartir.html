<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Compartir Rutinas</title>
<link rel="stylesheet" href="style.css">

</head>
<body>
<div class="container">
  <header>
    <h1>FREEGYM</h1>
    <nav>
        <button class="opcion" onclick="home()">Home</button>
        <button class="opcion" onclick="progreso()">Ver progreso</button>
        <button class="opcion" onclick="cerrarsesion()">Cerrar sesión</button>
        <button id="butsidebar">☰</button>
    </nav>
</header>
  <section>
<h2>Compartir Rutina</h2>

<h3 style="color: white;">Enviar rutina</h3>
<select id="misRutinasSelect"></select>
<input type="text" id="destinatario" placeholder="Buscar usuario...">
<div id="sugerencias"></div>
<button id="enviarBtn" class="boton">Enviar Rutina</button>
<div>
<h3 style="color: white;">Rutinas recibidas</h3>
<p style="color: white;" id="buzonList"></p>
</div>
</section>
</div>
<div id="sidebar">
  <button class="opcion" onclick="home()">Home</button>
  <button class="opcion" onclick="progreso()">Ver progreso</button>
  <button class="opcion" onclick="cerrarsesion()">Cerrar sesión</button>
</div>

<script src="src/JS/sidebar.js"></script>
<script>
  const JSONBIN_ID = "68b26e1e43b1c97be92ffba5"; // Tu JSONBin ID
  const JSONBIN_KEY = "$2a$10$N9BfvBkwc28noC55lGE5a.Yu7Ks9oGdImysR52pg8xPk4m/wsjQMe"; // Tu JSONBin API Key


let usuario=JSON.parse(localStorage.getItem("usuarioActivo"));
if(!usuario) window.location.href="index.html";

const misRutinasSelect=document.getElementById("misRutinasSelect"),
destinatarioInput=document.getElementById("destinatario"),
sugerenciasDiv=document.getElementById("sugerencias"),
enviarBtn=document.getElementById("enviarBtn"),
buzonList=document.getElementById("buzonList");

// Cargar rutinas propias
(usuario.rutinas||[]).forEach((r,i)=>{
  const o=document.createElement("option"); o.value=i; o.textContent=r.nombre;
  misRutinasSelect.appendChild(o);
});

// BUSCAR USUARIOS EN LOCAL
let usuarios=JSON.parse(localStorage.getItem("usuarios")||"[]");

// Sugerencias mientras escribís
destinatarioInput.addEventListener("input", ()=>{
  const texto=destinatarioInput.value.toLowerCase();
  const coincidencias=usuarios.filter(u=>u.nombre.toLowerCase().includes(texto)&&u.nombre.toLowerCase()!=usuario.nombre.toLowerCase());
  sugerenciasDiv.innerHTML=coincidencias.map(u=>`<button class="boton2" onclick="destinatarioInput.value='${u.nombre}'">${u.nombre}</button>`).join("");
});

// Funciones JSONBin
async function cargarBuzonOnline(){
  const res=await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_ID}/latest`, {
    headers: {"X-Access-Key":JSONBIN_KEY}
  });
  const data=await res.json();
  return data.record||[];
}

async function guardarBuzonOnline(buzon){
  await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_ID}`,{
    method:"PUT",
    headers: {
      "Content-Type":"application/json",
      "X-Access-Key":JSONBIN_KEY
    },
    body:JSON.stringify(buzon)
  });
}

// Enviar rutina
enviarBtn.addEventListener("click", async ()=>{
  const index=misRutinasSelect.value;
  const destinatario=destinatarioInput.value.trim().toLowerCase();
  if(!destinatario) return alert("Ingresa un usuario destinatario");

  const usuarioDest=usuarios.find(u=>u.nombre.toLowerCase()===destinatario);
  if(!usuarioDest) return alert("Usuario no encontrado");

  const rutina=usuario.rutinas[index];
  let buzon=await cargarBuzonOnline();
  buzon.push({destinatario, remitente:usuario.nombre, rutina, fecha:new Date().toISOString()});
  await guardarBuzonOnline(buzon);

  alert("Rutina enviada a "+destinatario);
  destinatarioInput.value="";
  sugerenciasDiv.innerHTML="";
  renderBuzon();
});

// Renderizar buzón de rutinas recibidas
async function renderBuzon(){
  buzonList.innerHTML="Cargando...";
  let buzon=await cargarBuzonOnline();
  let recibidas=buzon.filter(b=>b.destinatario===usuario.nombre.toLowerCase());
  if(recibidas.length===0){ buzonList.innerHTML="<li>No tienes rutinas nuevas</li>"; return; }

  buzonList.innerHTML="";
  recibidas.forEach((b,i)=>{
    const li=document.createElement("li");
    li.textContent=`${b.rutina.nombre} de ${b.remitente} (${new Date(b.fecha).toLocaleString()}) `;
    const btnAceptar=document.createElement("button"); 
    btnAceptar.textContent="Aceptar";
    btnAceptar.classList.add("boton")
    btnAceptar.style.marginLeft = "2vh"
    btnAceptar.addEventListener("click", async ()=>{
      usuario.rutinas=usuario.rutinas||[];
      usuario.rutinas.push(b.rutina);
      localStorage.setItem("usuarioActivo", JSON.stringify(usuario));

      // Quitar del buzón online
      buzon.splice(buzon.indexOf(b),1);
      await guardarBuzonOnline(buzon);
      renderBuzon();
      alert("Rutina aceptada y agregada a tus rutinas");
    });
    li.appendChild(btnAceptar);
    buzonList.appendChild(li);
  });
}

renderBuzon();
</script>
</body>
</html>
