<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Compartir Rutinas</title>
<style>
body{font-family:Arial;background:#f0f0f0;display:flex;justify-content:center;padding-top:20px;}
.container{background:white;padding:20px;border-radius:10px;width:650px;box-shadow:0 4px 10px rgba(0,0,0,0.2);}
input,select,button{width:100%;padding:8px;margin:5px 0;border-radius:5px;}
button{border:none;background:#007bff;color:white;cursor:pointer;}
button:hover{background:#0056b3;}
ul{padding-left:20px;}
li{margin-bottom:10px;}
#sugerencias div{cursor:pointer;padding:3px;}
#sugerencias div:hover{background:#ddd;}
</style>
</head>
<body>
<div class="container">
<h2>Compartir Rutina</h2>

<div>
<h4>Enviar rutina</h4>
<select id="misRutinasSelect"></select>
<input type="text" id="destinatario" placeholder="Buscar usuario...">
<div id="sugerencias"></div>
<button id="enviarBtn">Enviar Rutina</button>
</div>

<hr>

<div>
<h4>Rutinas recibidas</h4>
<ul id="buzonList"></ul>
</div>
</div>

<script>
  const JSONBIN_ID = "68b26e1e43b1c97be92ffba5"; // Tu JSONBin ID
  const JSONBIN_KEY = "$2a$10$N9BfvBkwc28noC55lGE5a.Yu7Ks9oGdImysR52pg8xPk4m/wsjQMe"; // Tu JSONBin API Key


let usuario=JSON.parse(localStorage.getItem("usuarioActivo"));
if(!usuario) window.location.href="index.html";

const misRutinasSelect=document.getElementById("misRutinasSelect"),
destinatarioInput=document.getElementById("destinatario"),
sugerenciasDiv=document.getElementById("sugerencias"),
enviarBtn=document.getElementById("enviarBtn"),
buzonList=document.getElementById("buzonList");

// Cargar rutinas propias
(usuario.rutinas||[]).forEach((r,i)=>{
  const o=document.createElement("option"); o.value=i; o.textContent=r.nombre;
  misRutinasSelect.appendChild(o);
});

// BUSCAR USUARIOS EN LOCAL
let usuarios=JSON.parse(localStorage.getItem("usuarios")||"[]");

// Sugerencias mientras escribís
destinatarioInput.addEventListener("input", ()=>{
  const texto=destinatarioInput.value.toLowerCase();
  const coincidencias=usuarios.filter(u=>u.nombre.toLowerCase().includes(texto)&&u.nombre.toLowerCase()!=usuario.nombre.toLowerCase());
  sugerenciasDiv.innerHTML=coincidencias.map(u=>`<div onclick="destinatarioInput.value='${u.nombre}'">${u.nombre}</div>`).join("");
});

// Funciones JSONBin
async function cargarBuzonOnline(){
  const res=await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_ID}/latest`, {
    headers: {"X-Access-Key":JSONBIN_KEY}
  });
  const data=await res.json();
  return data.record||[];
}

async function guardarBuzonOnline(buzon){
  await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_ID}`,{
    method:"PUT",
    headers: {
      "Content-Type":"application/json",
      "X-Access-Key":JSONBIN_KEY
    },
    body:JSON.stringify(buzon)
  });
}

// Enviar rutina
enviarBtn.addEventListener("click", async ()=>{
  const index=misRutinasSelect.value;
  const destinatario=destinatarioInput.value.trim().toLowerCase();
  if(!destinatario) return alert("Ingresa un usuario destinatario");

  const usuarioDest=usuarios.find(u=>u.nombre.toLowerCase()===destinatario);
  if(!usuarioDest) return alert("Usuario no encontrado");

  const rutina=usuario.rutinas[index];
  let buzon=await cargarBuzonOnline();
  buzon.push({destinatario, remitente:usuario.nombre, rutina, fecha:new Date().toISOString()});
  await guardarBuzonOnline(buzon);

  alert("Rutina enviada a "+destinatario);
  destinatarioInput.value="";
  sugerenciasDiv.innerHTML="";
  renderBuzon();
});

// Renderizar buzón de rutinas recibidas
async function renderBuzon(){
  buzonList.innerHTML="Cargando...";
  let buzon=await cargarBuzonOnline();
  let recibidas=buzon.filter(b=>b.destinatario===usuario.nombre.toLowerCase());
  if(recibidas.length===0){ buzonList.innerHTML="<li>No tienes rutinas nuevas</li>"; return; }

  buzonList.innerHTML="";
  recibidas.forEach((b,i)=>{
    const li=document.createElement("li");
    li.textContent=`${b.rutina.nombre} de ${b.remitente} (${new Date(b.fecha).toLocaleString()}) `;
    const btnAceptar=document.createElement("button"); btnAceptar.textContent="Aceptar";
    btnAceptar.addEventListener("click", async ()=>{
      usuario.rutinas=usuario.rutinas||[];
      usuario.rutinas.push(b.rutina);
      localStorage.setItem("usuarioActivo", JSON.stringify(usuario));

      // Quitar del buzón online
      buzon.splice(buzon.indexOf(b),1);
      await guardarBuzonOnline(buzon);
      renderBuzon();
      alert("Rutina aceptada y agregada a tus rutinas");
    });
    li.appendChild(btnAceptar);
    buzonList.appendChild(li);
  });
}

renderBuzon();
</script>
</body>
</html>
